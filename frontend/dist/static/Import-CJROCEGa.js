import{V as r,m as a,n as o}from"./index-BCeMOe0T.js";import{L as l}from"./ListSelector-IGEJSNAD.js";import{L as n}from"./LogView-l3D92uRY.js";const u=r.extend({components:{ListSelector:l,LogView:n},props:{data:{type:Object,default:()=>{}},isEditing:{type:Boolean,default:!1}},data(){return{form:{mode:"subscribe",subStatus:"unconfirmed",delim:",",lists:[],overwrite:!1,file:null,example:""},isLoading:!0,isProcessing:!1,status:{status:""},logs:[],pollID:null}},watch:{"form.mode":function(){this.$nextTick(()=>{this.form.mode==="subscribe"?this.form.subStatus="unconfirmed":this.form.subStatus="unsubscribed"})}},methods:{clearFile(){this.form.file=null},isFree(){return this.status.status==="none"},isRunning(){return this.status.status==="importing"||this.status.status==="stopping"},isSuccessful(){return this.status.status==="finished"},isFailed(){return this.status.status==="stopped"||this.status.status==="failed"},isDone(){return this.status.status==="finished"||this.status.status==="stopped"||this.status.status==="failed"},pollStatus(){clearInterval(this.pollID),this.pollID=setInterval(()=>(this.$api.getImportStatus().then(e=>{this.isProcessing=!1,this.isLoading=!1,this.status=e,this.getLogs(),this.isRunning()||clearInterval(this.pollID)},()=>{this.isProcessing=!1,this.isLoading=!1,this.status={status:"none"},clearInterval(this.pollID)}),!0),250)},getLogs(){this.$api.getImportLogs().then(e=>{this.logs=e.split(`
`).map(s=>s.replace(/\s+importer\.go:\d+:\s*/," *: ")),r.nextTick(()=>{const s=document.getElementById("import-log");s&&(s.scrollTop=s.scrollHeight)})})},stopImport(){this.isProcessing=!0,this.$api.stopImport().then(()=>{this.pollStatus(),this.form.file=null})},renderExample(){const e=`email,name,attributes
user1@mail.com,"User One","{""age"": 42, ""planet"": ""Mars""}"
user2@mail.com,"User Two","{""age"": 24, ""job"": ""Time Traveller""}"`;this.example=e},resetForm(){this.form.mode="subscribe",this.form.overwrite=!1,this.form.file=null,this.form.lists=[],this.form.subStatus="unconfirmed",this.form.delim=","},onUpload(){if(this.form.mode==="subscribe"&&this.form.overwrite){this.$utils.confirm(this.$t("import.subscribeWarning"),this.onSubmit,this.resetForm);return}this.onSubmit()},onSubmit(){this.isProcessing=!0;const e=new FormData;e.set("params",JSON.stringify({mode:this.form.mode,subscription_status:this.form.subStatus,delim:this.form.delim,lists:this.form.lists.map(s=>s.id),overwrite:this.form.overwrite})),e.set("file",this.form.file),this.$api.importSubscribers(e).then(()=>{this.$utils.toast(this.$t("import.importStarted")),this.pollStatus()},()=>{this.isProcessing=!1,this.form.file=null})}},computed:{...a(["lists"]),progress(){return!this.status||!this.status.total>0?0:Math.ceil(this.status.imported/this.status.total*100)}},mounted(){this.renderExample(),this.pollStatus();const e=this.$utils.parseQueryIDs(this.$route.query.list_id);e.length>0&&this.lists.results&&this.$nextTick(()=>{this.form.lists=this.lists.results.filter(s=>e.indexOf(s.id)>-1)})}});var m=function(){var s=this,t=s._self._c;return s._self._setupProxy,t("section",{staticClass:"import"},[t("h1",{staticClass:"title is-4"},[s._v(" "+s._s(s.$t("import.title"))+" ")]),t("b-loading",{attrs:{active:s.isLoading}}),s.isFree()?t("section",{staticClass:"wrap"},[t("form",{staticClass:"box",on:{submit:function(i){return i.preventDefault(),s.onUpload.apply(null,arguments)}}},[t("div",[t("div",{staticClass:"columns"},[t("div",{staticClass:"column"},[t("b-field",{attrs:{label:s.$t("import.mode"),addons:!1}},[t("div",[t("b-radio",{attrs:{name:"mode","native-value":"subscribe","data-cy":"check-subscribe"},model:{value:s.form.mode,callback:function(i){s.$set(s.form,"mode",i)},expression:"form.mode"}},[s._v(" "+s._s(s.$t("import.subscribe"))+" ")]),t("br"),t("b-radio",{attrs:{name:"mode","native-value":"blocklist","data-cy":"check-blocklist"},model:{value:s.form.mode,callback:function(i){s.$set(s.form,"mode",i)},expression:"form.mode"}},[s._v(" "+s._s(s.$t("import.blocklist"))+" ")])],1)])],1),t("div",{staticClass:"column"},[t("b-field",{attrs:{label:s.$t("globals.fields.status"),addons:!1}},[s.form.mode==="subscribe"?[t("b-radio",{attrs:{name:"subStatus","native-value":"unconfirmed","data-cy":"check-unconfirmed"},model:{value:s.form.subStatus,callback:function(i){s.$set(s.form,"subStatus",i)},expression:"form.subStatus"}},[s._v(" "+s._s(s.$t("subscribers.status.unconfirmed"))+" ")]),t("b-radio",{attrs:{name:"subStatus","native-value":"confirmed","data-cy":"check-confirmed"},model:{value:s.form.subStatus,callback:function(i){s.$set(s.form,"subStatus",i)},expression:"form.subStatus"}},[s._v(" "+s._s(s.$t("subscribers.status.confirmed"))+" ")])]:t("b-radio",{attrs:{name:"subStatus","native-value":"unsubscribed","data-cy":"check-unsubscribed"},model:{value:s.form.subStatus,callback:function(i){s.$set(s.form,"subStatus",i)},expression:"form.subStatus"}},[s._v(" "+s._s(s.$t("subscribers.status.unsubscribed"))+" ")])],2)],1),t("div",{staticClass:"column"},[s.form.mode==="subscribe"?t("b-field",{attrs:{label:s.$t("import.overwrite"),message:s.$t("import.overwriteHelp")}},[t("div",[t("b-switch",{attrs:{name:"overwrite","data-cy":"overwrite"},model:{value:s.form.overwrite,callback:function(i){s.$set(s.form,"overwrite",i)},expression:"form.overwrite"}})],1)]):s._e()],1),t("div",{staticClass:"column"},[t("b-field",{staticClass:"delimiter",attrs:{label:s.$t("import.csvDelim"),message:s.$t("import.csvDelimHelp")}},[t("b-input",{attrs:{name:"delim",placeholder:",",maxlength:"1",required:""},model:{value:s.form.delim,callback:function(i){s.$set(s.form,"delim",i)},expression:"form.delim"}})],1)],1)]),s.form.mode==="subscribe"?t("list-selector",{attrs:{label:s.$t("globals.terms.lists"),placeholder:s.$t("import.listSubHelp"),message:s.$t("import.listSubHelp"),selected:s.form.lists,all:s.lists.results},model:{value:s.form.lists,callback:function(i){s.$set(s.form,"lists",i)},expression:"form.lists"}}):s._e(),t("hr"),t("b-field",{attrs:{label:s.$t("import.csvFile"),"label-position":"on-border"}},[t("b-upload",{attrs:{"drag-drop":"",expanded:""},model:{value:s.form.file,callback:function(i){s.$set(s.form,"file",i)},expression:"form.file"}},[t("div",{staticClass:"has-text-centered section"},[t("p",[t("b-icon",{attrs:{icon:"file-upload-outline",size:"is-large"}})],1),t("p",[s._v(s._s(s.$t("import.csvFileHelp")))])])])],1),s.form.file?t("div",{staticClass:"tags"},[t("b-tag",{attrs:{size:"is-medium",closable:""},on:{close:s.clearFile}},[s._v(" "+s._s(s.form.file.name)+" ")])],1):s._e(),t("div",{staticClass:"buttons"},[t("b-button",{attrs:{"native-type":"submit",type:"is-primary",disabled:!s.form.file||s.form.mode==="subscribe"&&s.form.lists.length===0,loading:s.isProcessing}},[s._v(" "+s._s(s.$t("import.upload"))+" ")])],1)],1)]),t("br"),t("br"),t("div",{staticClass:"import-help"},[t("h5",{staticClass:"title is-size-6"},[s._v(" "+s._s(s.$t("import.instructions"))+" ")]),t("p",[s._v(s._s(s.$t("import.instructionsHelp")))]),t("br"),s._m(0),t("hr"),t("h5",{staticClass:"title is-size-6"},[s._v(" "+s._s(s.$t("import.csvExample"))+" ")]),t("pre",{staticClass:"csv-example",domProps:{textContent:s._s(s.example)}})])]):s._e(),s.isRunning()||s.isDone()?t("section",{staticClass:"wrap status box has-text-centered"},[t("b-progress",{attrs:{value:s.progress,"show-value":"",type:"is-success"}}),t("br"),t("p",{class:["is-size-5","is-capitalized",{"has-text-success":s.status.status==="finished"},{"has-text-danger":s.status.status==="failed"||s.status.status==="stopped"}]},[s._v(" "+s._s(s.status.status)+" ")]),t("p",[s._v(s._s(s.$t("import.recordsCount",{num:s.status.imported,total:s.status.total})))]),t("br"),t("p",[t("b-button",{attrs:{loading:s.isProcessing,"icon-left":"file-upload-outline",type:"is-primary"},on:{click:s.stopImport}},[s._v(" "+s._s(s.isDone()?s.$t("import.importDone"):s.$t("import.stopImport"))+" ")])],1),t("br"),t("div",{staticClass:"import-logs"},[t("log-view",{attrs:{lines:s.logs,loading:!1}})],1)],1):s._e()],1)},c=[function(){var e=this,s=e._self._c;return e._self._setupProxy,s("blockquote",{staticClass:"csv-example"},[s("code",{staticClass:"csv-headers"},[s("span",[e._v("email,")]),e._v(" "),s("span",[e._v("name,")]),e._v(" "),s("span",[e._v("attributes")])])])}],d=o(u,m,c);const h=d.exports;export{h as default};
