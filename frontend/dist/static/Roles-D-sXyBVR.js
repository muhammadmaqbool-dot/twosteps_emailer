import{V as a,m as o,n}from"./index-BCeMOe0T.js";import{E as u}from"./EmptyPlaceholder-C9_D_EHA.js";import{C as d}from"./CopyText-Da2spgK4.js";const c=a.extend({name:"RoleForm",components:{CopyText:d},props:{data:{type:Object,default:()=>({})},isEditing:{type:Boolean,default:!1},type:{type:String,default:"user"}},data(){return{form:{curList:null,lists:[],name:null,permissions:{}},hasToggle:!1,disabled:!1}},methods:{onAddListPerm(){const i=this.lists.results.find(s=>s.id===this.form.curList);this.form.lists.push({id:i.id,name:i.name,permissions:["list:get","list:manage"]}),this.form.curList=this.filteredLists.length>0?this.filteredLists[0].id:null},onDeleteListPerm(i){this.form.lists=this.form.lists.filter(s=>s.id!==i),this.form.curList=this.filteredLists.length>0?this.filteredLists[0].id:null},onSubmit(){if(this.isEditing){this.updateRole();return}this.createRole()},onToggleSelect(){this.hasToggle?this.form.permissions=[]:this.form.permissions=this.serverConfig.permissions.reduce((i,s)=>(s.permissions.forEach(t=>{i.push(t)}),i),[]),this.hasToggle=!this.hasToggle},createRole(){let i;const s={name:this.form.name};this.$props.type==="user"?(i=this.$api.createUserRole,s.permissions=this.form.permissions):(i=this.$api.createListRole,s.lists=this.form.lists.reduce((t,e)=>(t.push({id:e.id,permissions:e.permissions}),t),[])),i(s).then(t=>{this.$emit("finished"),this.$utils.toast(this.$t("globals.messages.created",{name:t.name})),this.$parent.close()})},updateRole(){let i;const s={id:this.$props.data.id,name:this.form.name};this.$props.type==="user"?(i=this.$api.updateUserRole,s.permissions=this.form.permissions):(i=this.$api.updateListRole,s.lists=this.form.lists.reduce((t,e)=>(t.push({id:e.id,permissions:e.permissions}),t),[])),i(s).then(t=>{this.$emit("finished"),this.$utils.toast(this.$t("globals.messages.updated",{name:t.name})),this.$parent.close()})}},computed:{...o(["loading","serverConfig","lists"]),filteredLists(){if(!this.lists.results||this.type!=="list")return[];const i=this.form.lists.reduce((s,t)=>({...s,[t.id]:!0}),{});return this.lists.results.filter(s=>!(s.id in i))}},mounted(){if(this.isEditing)this.form={...this.form,...this.$props.data},(this.$props.data.id===1||!this.$can("roles:manage"))&&(this.disabled=!0);else{const i=["admin","users"];this.form.permissions=this.serverConfig.permissions.reduce((s,t)=>(i.includes(t.group)||t.permissions.forEach(e=>{e!=="subscribers:sql_query"&&!e.startsWith("lists:")&&!e.startsWith("settings:")&&s.push(e)}),s),[])}this.$nextTick(()=>{this.filteredLists.length>0&&(this.form.curList=this.filteredLists[0].id),this.$refs.focus.focus()})}});var m=function(){var s=this,t=s._self._c;return s._self._setupProxy,t("form",{on:{submit:function(e){return e.preventDefault(),s.onSubmit.apply(null,arguments)}}},[t("div",{staticClass:"modal-card content",staticStyle:{width:"auto"}},[t("header",{staticClass:"modal-card-head"},[s.isEditing?t("p",{staticClass:"has-text-grey-light is-size-7"},[s._v(" "+s._s(s.$t("globals.fields.id"))+": "),t("copy-text",{attrs:{text:`${s.data.id}`}})],1):s._e(),s.isEditing?t("h4",[s._v(" "+s._s(s.data.name)+" ")]):t("h4",[s._v(" "+s._s(s.type==="user"?s.$t("users.newUserRole"):s.$t("users.newListRole"))+" ")])]),t("section",{staticClass:"modal-card-body",attrs:{expanded:""}},[t("b-field",{attrs:{label:s.$t("globals.fields.name"),"label-position":"on-border"}},[t("b-input",{ref:"focus",attrs:{autofocus:"",disabled:s.disabled,maxlength:200,name:"name",required:""},model:{value:s.form.name,callback:function(e){s.$set(s.form,"name",e)},expression:"form.name"}})],1),s.type==="list"?t("div",{staticClass:"box"},[t("h5",[s._v(s._s(s.$t("users.listPerms")))]),t("div",{staticClass:"mb-5"},[t("div",{staticClass:"columns"},[t("div",{staticClass:"column is-9"},[t("b-select",{staticClass:"mb-3",attrs:{placeholder:s.$tc("globals.terms.list"),name:"list",disabled:s.disabled||s.filteredLists.length<1,expanded:""},model:{value:s.form.curList,callback:function(e){s.$set(s.form,"curList",e)},expression:"form.curList"}},[s._l(s.filteredLists,function(e){return[t("option",{key:e.id,domProps:{value:e.id}},[s._v(" "+s._s(e.name)+" ")])]})],2)],1),t("div",{staticClass:"column"},[t("b-button",{staticClass:"is-primary",attrs:{disabled:!s.form.curList,expanded:""},on:{click:s.onAddListPerm}},[s._v(" "+s._s(s.$t("globals.buttons.add"))+" ")])],1)]),s.form.lists.length>0&&(s.form.permissions["lists:get_all"]||s.form.permissions["lists:manage_all"])?t("span",{staticClass:"is-size-6 has-text-danger"},[t("b-icon",{attrs:{icon:"warning-empty"}}),s._v(" "+s._s(s.$t("users.listPermsWarning"))+" ")],1):s._e()]),t("b-table",{attrs:{data:s.form.lists}},[t("b-table-column",{attrs:{field:"name",label:s.$tc("globals.terms.list")},scopedSlots:s._u([{key:"default",fn:function(e){return[t("router-link",{attrs:{to:`/lists/${e.row.id}`,target:"_blank"}},[s._v(" "+s._s(e.row.name)+" ")])]}}],null,!1,3420267636)}),t("b-table-column",{attrs:{field:"permissions",label:s.$t("users.perms"),width:"40%"},scopedSlots:s._u([{key:"default",fn:function(e){return[t("b-checkbox",{attrs:{"native-value":"list:get"},model:{value:e.row.permissions,callback:function(l){s.$set(e.row,"permissions",l)},expression:"props.row.permissions"}},[s._v(" "+s._s(s.$t("globals.buttons.view"))+" ")]),t("b-checkbox",{attrs:{"native-value":"list:manage"},model:{value:e.row.permissions,callback:function(l){s.$set(e.row,"permissions",l)},expression:"props.row.permissions"}},[s._v(" "+s._s(s.$t("globals.buttons.manage"))+" ")])]}}],null,!1,601622987)}),t("b-table-column",{attrs:{width:"10%"},scopedSlots:s._u([{key:"default",fn:function(e){return[t("a",{attrs:{href:"#","data-cy":"btn-delete","aria-label":s.$t("globals.buttons.delete")},on:{click:function(l){return l.preventDefault(),s.onDeleteListPerm(e.row.id)}}},[t("b-tooltip",{attrs:{label:s.$t("globals.buttons.delete"),type:"is-dark"}},[t("b-icon",{attrs:{icon:"trash-can-outline",size:"is-small"}})],1)],1)]}}],null,!1,2083850003)})],1)],1):s._e(),s.type==="user"?[t("div",{staticClass:"columns"},[t("div",{staticClass:"column is-7"},[t("h5",{staticClass:"mb-0"},[s._v(" "+s._s(s.$t("users.perms"))+" ")])]),s.disabled?s._e():t("div",{staticClass:"column has-text-right"},[t("a",{attrs:{href:"#"},on:{click:function(e){return e.preventDefault(),s.onToggleSelect.apply(null,arguments)}}},[s._v(s._s(s.$t("globals.buttons.toggleSelect")))])])]),t("b-table",{attrs:{data:s.serverConfig.permissions}},[t("b-table-column",{attrs:{field:"group",label:s.$t("users.roleGroup")},scopedSlots:s._u([{key:"default",fn:function(e){return[s._v(" "+s._s(s.$tc(`globals.terms.${e.row.group}`))+" ")]}}],null,!1,1297503159)}),t("b-table-column",{attrs:{field:"permissions",label:"Permissions"},scopedSlots:s._u([{key:"default",fn:function(e){return s._l(e.row.permissions,function(l){return t("div",{key:l},[t("b-checkbox",{attrs:{"native-value":l,disabled:s.disabled},model:{value:s.form.permissions,callback:function(r){s.$set(s.form,"permissions",r)},expression:"form.permissions"}},[s._v(" "+s._s(l)+" ")])],1)})}}],null,!1,948680651)})],1)]:s._e(),t("a",{attrs:{href:"https://listmonk.app/docs/roles-and-permissions",target:"_blank",rel:"noopener noreferrer"}},[t("b-icon",{attrs:{icon:"link-variant"}}),s._v(" "+s._s(s.$t("globals.buttons.learnMore"))+" ")],1)],2),t("footer",{staticClass:"modal-card-foot has-text-right"},[t("b-button",{on:{click:function(e){return s.$parent.close()}}},[s._v(" "+s._s(s.$t("globals.buttons.close"))+" ")]),s.disabled?s._e():t("b-button",{attrs:{"native-type":"submit",type:"is-primary",loading:s.loading.roles,"data-cy":"btn-save"}},[s._v(" "+s._s(s.$t("globals.buttons.save"))+" ")])],1)])])},f=[],h=n(c,m,f);const p=h.exports,b=a.extend({components:{EmptyPlaceholder:u,RoleForm:p},data(){return{curItem:null,curType:null,isEditing:!1,isFormVisible:!1}},methods:{isLoading(){return this.curType==="user"?this.loading.userRoles:this.loading.listRoles},fetchRoles(){this.isUser?this.$api.getUserRoles():this.$api.getListRoles()},showEditForm(i){this.curItem=i,this.curType=this.isUser?"user":"list",this.isFormVisible=!0,this.isEditing=!0},showNewForm(){this.isEditing=!1,this.isFormVisible=!0},formFinished(){this.fetchRoles()},onFormClose(){this.$route.params.id&&this.$router.push({name:"users"})},onCloneRole(i,s){const t={name:i};let e;this.isUser?(e=this.$api.createUserRole,t.permissions=s.permissions):(e=this.$api.createListRole,t.lists=s.lists),e(t).then(()=>{this.fetchRoles(),this.$utils.toast(this.$t("globals.messages.created",{name:i}))})},onDeleteRole(i){this.$utils.confirm(this.$t("globals.messages.confirm"),()=>{this.$api.deleteRole(i.id).then(()=>{this.fetchRoles(),this.$utils.toast(this.$t("globals.messages.deleted",{name:i.name}))})})}},computed:{...o(["loading","userRoles","listRoles"]),isUser(){return this.curType==="user"},isList(){return this.curType==="list"},roles(){return this.isUser?this.userRoles:this.listRoles}},mounted(){this.curType=this.$route.name==="userRoles"?"user":"list",this.fetchRoles()}});var g=function(){var s=this,t=s._self._c;return s._self._setupProxy,t("section",{staticClass:"roles"},[t("header",{staticClass:"columns page-header"},[t("div",{staticClass:"column is-10"},[t("h1",{staticClass:"title is-4"},[s._v(" "+s._s(s.$t(s.isUser?"users.userRoles":"users.listRoles"))+" "),isNaN(s.roles.length)?s._e():t("span",[s._v("("+s._s(s.roles.length)+")")])])]),t("div",{staticClass:"column has-text-right"},[s.$can("users:manage")?t("b-field",{attrs:{expanded:""}},[t("b-button",{staticClass:"btn-new",attrs:{expanded:"",type:"is-primary","icon-left":"plus","data-cy":"btn-new"},on:{click:function(e){return s.showNewForm("user")}}},[s._v(" "+s._s(s.$t("globals.buttons.new"))+" ")])],1):s._e()],1)]),t("b-table",{attrs:{data:s.roles,loading:s.isLoading(),hoverable:""},scopedSlots:s._u([s.isLoading()?null:{key:"empty",fn:function(){return[t("empty-placeholder")]},proxy:!0}],null,!0)},[t("b-table-column",{attrs:{field:"role",label:s.$tc("users.role"),sortable:""},scopedSlots:s._u([{key:"default",fn:function(e){return[t("a",{attrs:{href:"#"},on:{click:function(l){return l.preventDefault(),s.showEditForm(e.row,"user")}}},[e.row.id===1?t("b-tag",{staticClass:"enabled"},[s._v(" "+s._s(e.row.name)+" ")]):[s._v(s._s(e.row.name))]],2)]}}])}),t("b-table-column",{attrs:{field:"created_at",label:s.$t("globals.fields.createdAt"),"header-class":"cy-created_at",sortable:""},scopedSlots:s._u([{key:"default",fn:function(e){return[s._v(" "+s._s(s.$utils.niceDate(e.row.createdAt))+" ")]}}])}),t("b-table-column",{attrs:{field:"updated_at",label:s.$t("globals.fields.updatedAt"),"header-class":"cy-updated_at",sortable:""},scopedSlots:s._u([{key:"default",fn:function(e){return[s._v(" "+s._s(s.$utils.niceDate(e.row.updatedAt))+" ")]}}])}),t("b-table-column",{attrs:{"cell-class":"actions has-text-right"},scopedSlots:s._u([{key:"default",fn:function(e){return[s.$can("roles:manage")?[t("a",{attrs:{href:"#","data-cy":"btn-clone","aria-label":s.$t("globals.buttons.clone")},on:{click:function(l){l.preventDefault(),s.$utils.prompt(s.$t("globals.buttons.clone"),{placeholder:s.$t("globals.fields.name"),value:s.$t("campaigns.copyOf",{name:e.row.name})},r=>s.onCloneRole(r,e.row))}}},[t("b-tooltip",{attrs:{label:s.$t("globals.buttons.clone"),type:"is-dark"}},[t("b-icon",{attrs:{icon:"file-multiple-outline",size:"is-small"}})],1)],1),e.row.id!==1?[t("a",{attrs:{href:"#","data-cy":"btn-edit","aria-label":s.$t("globals.buttons.edit")},on:{click:function(l){return l.preventDefault(),s.showEditForm(e.row,"user")}}},[t("b-tooltip",{attrs:{label:s.$t("globals.buttons.edit"),type:"is-dark"}},[t("b-icon",{attrs:{icon:"pencil-outline",size:"is-small"}})],1)],1),t("a",{attrs:{href:"#","data-cy":"btn-delete","aria-label":s.$t("globals.buttons.delete")},on:{click:function(l){return l.preventDefault(),s.onDeleteRole(e.row)}}},[t("b-tooltip",{attrs:{label:s.$t("globals.buttons.delete"),type:"is-dark"}},[t("b-icon",{attrs:{icon:"trash-can-outline",size:"is-small"}})],1)],1)]:s._e()]:s._e()]}}])})],1),t("b-modal",{attrs:{scroll:"keep","aria-modal":!0,active:s.isFormVisible,width:700},on:{"update:active":function(e){s.isFormVisible=e},close:s.onFormClose}},[t("role-form",{attrs:{data:s.curItem,type:s.curType,"is-editing":s.isEditing},on:{finished:s.formFinished}})],1)],1)},_=[],$=n(b,g,_);const w=$.exports;export{w as default};
