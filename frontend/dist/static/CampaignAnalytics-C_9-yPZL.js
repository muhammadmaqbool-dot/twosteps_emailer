import{c as g,V as C,d as r,m as b,n as y}from"./index-BCeMOe0T.js";import{C as k}from"./Chart-TdIHOiDc.js";const p="#ee7d5b",h=[g.primary,"#FFB50D","#41AC9C",p,"#7FC7BC","#3a82d6","#688ED9","#FFC43D"],_=C.extend({components:{Chart:k},data(){return{isSearchLoading:!1,queriedCampaigns:[],counts:{views:0,clicks:0,bounces:0,links:0},urls:[],charts:{views:{name:this.$t("campaigns.views"),type:"line",data:null,fn:this.$api.getCampaignViewCounts,chartFn:this.makeCharts,loading:!1},clicks:{name:this.$t("campaigns.clicks"),type:"line",data:null,fn:this.$api.getCampaignClickCounts,chartFn:this.makeCharts,loading:!1},bounces:{name:this.$t("globals.terms.bounces"),type:"line",data:null,fn:this.$api.getCampaignBounceCounts,chartFn:this.makeCharts,donutColor:p,loading:!1},links:{name:this.$t("analytics.links"),type:"bar",data:null,chart:null,loading:!1,fn:this.$api.getCampaignLinkCounts,chartFn:this.makeLinksChart,onClick:this.onLinkClick}},form:{campaigns:[],from:null,to:null}}},methods:{onFromDateChange(){this.form.from>this.form.to&&(this.form.to=r(this.form.from).add(7,"day").toDate())},onToDateChange(){this.form.from>this.form.to&&(this.form.from=r(this.form.to).add(-7,"day").toDate())},formatDateTime(e){return r(e).format("YYYY-MM-DD HH:mm")},isCampaignSelected(e){return!this.form.campaigns.find(({id:t})=>t===e.id)},makeLinksChart(e,t,a){return{points:{labels:a.map(i=>{try{this.urls.push(i.url);const o=new URL(i.url);return i.url.length>80?`${o.hostname}${o.pathname.substr(0,50)}..`:o.hostname+o.pathname}catch{return i.url}}),datasets:[{data:a.map(i=>i.count),backgroundColor:h}]},donut:null}},makeCharts(e,t,a){const s=t.reduce((c,m)=>{const u={...c};return u[m.id]=m,u},{}),n=Object.keys(s),i=n.map((c,m)=>{const u=parseInt(c,10),d=a.filter(l=>l.campaignId===u);return{label:s[c].name,data:d.map(l=>({x:this.formatDateTime(l.timestamp),y:l.count})),borderColor:h[m%n.length],borderWidth:2,pointHoverBorderWidth:5,pointBorderWidth:.5}}),o=[],f=n.map(c=>{o.push(s[c].name);const m=parseInt(c,10);return a.reduce((d,l)=>l.campaignId===m?d+l.count:d,0)});return{points:{datasets:i},donut:{labels:o,datasets:[{data:f,backgroundColor:h,borderWidth:6}]}}},onSubmit(){this.$router.push({query:{id:this.form.campaigns.map(e=>e.id),from:r(this.form.from).unix(),to:r(this.form.to).unix()}})},queryCampaigns(e){this.isSearchLoading=!0,this.$api.getCampaigns({query:e,order_by:"created_at",order:"DESC"}).then(t=>{this.isSearchLoading=!1,this.queriedCampaigns=t.results.map(a=>{const s=a;return s.name=`#${a.id}: ${a.name}`,s})})},getData(e,t){this.charts[e].loading=!0,this.charts[e].fn({id:t.map(a=>a.id),from:this.form.from,to:this.form.to}).then(a=>{this.counts[e]=a.reduce((i,o)=>i+o.count,0);const{points:s,donut:n}=this.charts[e].chartFn(e,t,a);this.charts[e].data=s,this.charts[e].donutData=n,this.charts[e].loading=!1})},onLinkClick(e){const t=e.chart.getElementsAtEventForMode(e,"nearest",{intersect:!0},!0);t.length>0&&window.open(this.urls[t[0].index],"_blank","noopener noreferrer")}},computed:{...b(["settings"])},created(){const e=r().set("hour",23).set("minute",59).set("seconds",0),t=e.subtract(7,"day").set("hour",0).set("minute",0),a=this.$route.query.from?r.unix(this.$route.query.from):t,s=this.$route.query.to?r.unix(this.$route.query.to):e;this.form.from=a.toDate(),this.form.to=s.toDate()},mounted(){const e=this.$utils.parseQueryIDs(this.$route.query.id);e.length>0&&(this.isSearchLoading=!0,Promise.allSettled(e.map(t=>this.$api.getCampaign(t))).then(t=>{t.forEach(a=>{if(a.status!=="fulfilled")return;const s=a.value;s.name=`#${s.id}: ${s.name}`,this.form.campaigns.push(s)}),this.$nextTick(()=>{this.isSearchLoading=!1,Object.keys(this.charts).forEach(a=>{this.charts[a].data=null,this.charts[a].donutData=null,this.getData(a,this.form.campaigns)})})}))}});var $=function(){var t=this,a=t._self._c;return t._self._setupProxy,a("section",{staticClass:"analytics content relative"},[a("h1",{staticClass:"title is-4"},[t._v(" "+t._s(t.$t("analytics.title"))+" ")]),a("hr"),a("form",{on:{submit:function(s){return s.preventDefault(),t.onSubmit.apply(null,arguments)}}},[a("div",{staticClass:"columns"},[a("div",{staticClass:"column is-6"},[a("b-field",{attrs:{label:t.$t("globals.terms.campaigns"),"label-position":"on-border"}},[a("b-taginput",{attrs:{data:t.queriedCampaigns,name:"campaigns",ellipsis:"",icon:"tag-outline",placeholder:t.$t("globals.terms.campaigns"),autocomplete:"","allow-new":!1,"before-adding":t.isCampaignSelected,field:"name",loading:t.isSearchLoading},on:{typing:t.queryCampaigns},model:{value:t.form.campaigns,callback:function(s){t.$set(t.form,"campaigns",s)},expression:"form.campaigns"}})],1)],1),a("div",{staticClass:"column is-5"},[a("div",{staticClass:"columns"},[a("div",{staticClass:"column is-6"},[a("b-field",{attrs:{"data-cy":"from",label:t.$t("analytics.fromDate"),"label-position":"on-border"}},[a("b-datetimepicker",{attrs:{icon:"calendar-clock",timepicker:{hourFormat:"24"},"datetime-formatter":t.formatDateTime},on:{input:t.onFromDateChange},model:{value:t.form.from,callback:function(s){t.$set(t.form,"from",s)},expression:"form.from"}})],1)],1),a("div",{staticClass:"column is-6"},[a("b-field",{attrs:{"data-cy":"to",label:t.$t("analytics.toDate"),"label-position":"on-border"}},[a("b-datetimepicker",{attrs:{icon:"calendar-clock",timepicker:{hourFormat:"24"},"datetime-formatter":t.formatDateTime},on:{input:t.onToDateChange},model:{value:t.form.to,callback:function(s){t.$set(t.form,"to",s)},expression:"form.to"}})],1)],1)])]),a("div",{staticClass:"column is-1"},[a("b-button",{attrs:{"native-type":"submit",type:"is-primary","icon-left":"magnify",disabled:t.form.campaigns.length===0,"data-cy":"btn-search"}})],1)])]),a("p",{staticClass:"is-size-7 mt-2 has-text-grey-light"},[t.settings["privacy.individual_tracking"]?[t._v(" "+t._s(t.$t("analytics.isUnique"))+" ")]:[t._v(" "+t._s(t.$t("analytics.nonUnique"))+" ")]],2),a("section",{staticClass:"charts mt-5"},t._l(t.charts,function(s,n){return a("div",{key:n,staticClass:"chart"},[a("div",{staticClass:"columns"},[a("div",{staticClass:"column is-9"},[s.loading?a("b-loading",{attrs:{active:s.loading,"is-full-page":!1}}):t._e(),s.chart!==null?a("h4",[t._v(" "+t._s(s.name)+" "),a("span",{staticClass:"has-text-grey-light"},[t._v("("+t._s(t.$utils.niceNumber(t.counts[n]))+")")])]):t._e(),s.loading?t._e():a("chart",{attrs:{type:s.type,data:s.data,"on-click":s.onClick}})],1),a("div",{staticClass:"column is-2 donut-container"},[s.loading?t._e():a("chart",{attrs:{type:"donut",data:s.donutData}})],1)])])}),0)])},D=[],v=y(_,$,D);const S=v.exports;export{S as default};
