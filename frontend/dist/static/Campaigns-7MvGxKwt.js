import{V as c,d as u,m,n as d}from"./index-BCeMOe0T.js";import{C as p}from"./CampaignPreview-C9ISvStt.js";import{E as g}from"./EmptyPlaceholder-C9_D_EHA.js";import{C as b}from"./CopyText-Da2spgK4.js";const h=c.extend({components:{CampaignPreview:p,EmptyPlaceholder:g,CopyText:b},data(){return{previewItem:null,queryParams:{page:1,query:"",orderBy:"created_at",order:"desc"},pollID:null,campaignStatsData:{}}},methods:{canStart(s){return s.status==="draft"&&!s.sendAt},canSchedule(s){return s.status==="draft"&&s.sendAt},canPause(s){return s.status==="running"},canCancel(s){return s.status==="running"||s.status==="paused"},canResume(s){return s.status==="paused"},isSheduled(s){return s.status==="scheduled"||s.sendAt!==null},isDone(s){return s.status==="finished"||s.status==="cancelled"},isRunning(s){return s in this.campaignStatsData},highlightedRow(s){return s.status==="running"?["running"]:""},onPageChange(s){this.queryParams.page=s,this.getCampaigns()},onSort(s,t){this.queryParams.orderBy=s,this.queryParams.order=t,this.getCampaigns()},previewCampaign(s){this.previewItem=s},closePreview(){this.previewItem=null},getCampaigns(){this.$api.getCampaigns({page:this.queryParams.page,query:this.queryParams.query.replace(/[^\p{L}\p{N}\s]/gu," "),order_by:this.queryParams.orderBy,order:this.queryParams.order,no_body:!0})},getCampaignStats(s){return s.id in this.campaignStatsData?this.campaignStatsData[s.id]:s},pollStats(){clearInterval(this.pollID),this.pollID=setInterval(()=>{this.$api.getCampaignStats().then(s=>{s.length===0?(clearInterval(this.pollID),Object.keys(this.campaignStatsData).length>0&&(this.getCampaigns(),this.campaignStatsData={})):this.campaignStatsData=s.reduce((t,a)=>({...t,[a.id]:a}),{})},()=>{clearInterval(this.pollID)})},1e3)},changeCampaignStatus(s,t){this.$api.changeCampaignStatus(s.id,t).then(()=>{this.$utils.toast(this.$t("campaigns.statusChanged",{name:s.name,status:t})),this.getCampaigns(),this.pollStats()})},async cloneCampaign(s,t){let a="",e=null;await this.$api.getCampaign(t.id).then(n=>{a=n.body,e=n.bodySource});const i=this.$utils.getDate(),l=!!t.sendAt;let r=null;l&&(r=u(t.sendAt).isAfter(i)?t.sendAt:i.add(7,"day"));const o={name:s,subject:t.subject,lists:t.lists.map(n=>n.id),type:t.type,from_email:t.fromEmail,content_type:t.contentType,messenger:t.messenger,tags:t.tags,template_id:t.templateId,body:a,body_source:e,altbody:t.altbody,headers:t.headers,send_later:l,send_at:r,archive:t.archive,archive_template_id:t.archiveTemplateId,archive_meta:t.archiveMeta,media:t.media.map(n=>n.id)};t.archive&&(o.archive_slug=`${s.toLowerCase().replace(/[^a-z0-9]/g,"-")}-${Date.now().toString().slice(-4)}`),this.$api.createCampaign(o).then(n=>{this.$router.push({name:"campaign",params:{id:n.id}})})},deleteCampaign(s){this.$api.deleteCampaign(s.id).then(()=>{this.getCampaigns(),this.$utils.toast(this.$t("globals.messages.deleted",{name:s.name}))})}},computed:{...m(["campaigns","loading"])},mounted(){this.getCampaigns(),this.pollStats()},destroyed(){clearInterval(this.pollID)}});var f=function(){var t=this,a=t._self._c;return t._self._setupProxy,a("section",{staticClass:"campaigns"},[a("header",{staticClass:"columns page-header"},[a("div",{staticClass:"column is-10"},[a("h1",{staticClass:"title is-4"},[t._v(" "+t._s(t.$t("globals.terms.campaigns"))+" "),isNaN(t.campaigns.total)?t._e():a("span",[t._v("("+t._s(t.campaigns.total)+")")])])]),a("div",{staticClass:"column has-text-right"},[t.$can("campaigns:manage")?a("b-field",{attrs:{expanded:""}},[a("b-button",{staticClass:"btn-new",attrs:{expanded:"",to:{name:"campaign",params:{id:"new"}},tag:"router-link",type:"is-primary","icon-left":"plus","data-cy":"btn-new"}},[t._v(" "+t._s(t.$t("globals.buttons.new"))+" ")])],1):t._e()],1)]),a("b-table",{attrs:{data:t.campaigns.results,loading:t.loading.campaigns,"row-class":t.highlightedRow,paginated:"","backend-pagination":"","pagination-position":"both","current-page":t.queryParams.page,"per-page":t.campaigns.perPage,total:t.campaigns.total,hoverable:"","backend-sorting":""},on:{"page-change":t.onPageChange,sort:t.onSort},scopedSlots:t._u([{key:"top-left",fn:function(){return[a("div",{staticClass:"columns"},[a("div",{staticClass:"column is-6"},[a("form",{on:{submit:function(e){return e.preventDefault(),t.getCampaigns.apply(null,arguments)}}},[a("div",[a("b-field",[a("b-input",{ref:"query",attrs:{name:"query",expanded:"",placeholder:t.$t("campaigns.queryPlaceholder"),icon:"magnify"},model:{value:t.queryParams.query,callback:function(e){t.$set(t.queryParams,"query",e)},expression:"queryParams.query"}}),a("p",{staticClass:"controls"},[a("b-button",{attrs:{"native-type":"submit",type:"is-primary","icon-left":"magnify"}})],1)],1)],1)])])])]},proxy:!0},t.loading.campaigns?null:{key:"empty",fn:function(){return[a("empty-placeholder")]},proxy:!0}],null,!0)},[a("b-table-column",{attrs:{"cell-class":"status",field:"status",label:t.$t("globals.fields.status"),width:"10%",sortable:"","td-attrs":t.$utils.tdID,"header-class":"cy-status"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",[a("p",[a("router-link",{attrs:{to:{name:"campaign",params:{id:e.row.id}}}},[a("b-tag",{class:e.row.status},[t._v(" "+t._s(t.$t(`campaigns.status.${e.row.status}`))+" ")]),t.isRunning(e.row.id)?a("span",{staticClass:"spinner is-tiny"},[a("b-loading",{attrs:{"is-full-page":!1,active:""}})],1):t._e()],1)],1),t.isSheduled(e.row)?a("p",[a("span",{staticClass:"is-size-7 has-text-grey scheduled"},[a("b-icon",{attrs:{icon:"alarm",size:"is-small"}}),!t.isDone(e.row)&&!t.isRunning(e.row)?a("span",[t._v(" "+t._s(t.$utils.duration(new Date,e.row.sendAt,!0))+" "),a("br")]):t._e(),t._v(" "+t._s(t.$utils.niceDate(e.row.sendAt,!0))+" ")],1)]):t._e()])]}}])}),a("b-table-column",{attrs:{field:"name",label:t.$t("globals.fields.name"),width:"25%",sortable:"","header-class":"cy-name"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",[a("p",[e.row.type==="optin"?a("b-tag",{staticClass:"is-small"},[t._v(" "+t._s(t.$t("lists.optin"))+" ")]):t._e(),a("router-link",{attrs:{to:{name:"campaign",params:{id:e.row.id}}}},[t._v(" "+t._s(e.row.name)+" "),a("copy-text",{attrs:{text:e.row.name,"hide-text":""}})],1)],1),a("p",{staticClass:"is-size-7 has-text-grey"},[a("copy-text",{attrs:{text:e.row.subject}})],1),a("b-taglist",t._l(e.row.tags,function(i){return a("b-tag",{key:i,staticClass:"is-small"},[t._v(" "+t._s(i)+" ")])}),1)],1)]}}])}),a("b-table-column",{attrs:{"cell-class":"lists",field:"lists",label:t.$t("globals.terms.lists"),width:"15%"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("ul",t._l(e.row.lists,function(i){return a("li",{key:i.id},[a("router-link",{attrs:{to:{name:"subscribers_list",params:{listID:i.id}}}},[t._v(" "+t._s(i.name)+" ")])],1)}),0)]}}])}),a("b-table-column",{attrs:{field:"created_at",label:t.$t("campaigns.timestamps"),width:"19%",sortable:"","header-class":"cy-timestamp"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",{staticClass:"fields timestamps",attrs:{set:t.stats=t.getCampaignStats(e.row)}},[a("p",[a("label",{attrs:{for:"#"}},[t._v(t._s(t.$t("globals.fields.createdAt")))]),a("span",[t._v(t._s(t.$utils.niceDate(e.row.createdAt,!0)))])]),t.stats.startedAt?a("p",[a("label",{attrs:{for:"#"}},[t._v(t._s(t.$t("campaigns.startedAt")))]),a("span",[t._v(t._s(t.$utils.niceDate(t.stats.startedAt,!0)))])]):t._e(),t.isDone(e.row)?a("p",[a("label",{attrs:{for:"#"}},[t._v(t._s(t.$t("campaigns.ended")))]),a("span",[t._v(t._s(t.$utils.niceDate(t.stats.updatedAt,!0)))])]):t._e(),t.stats.startedAt&&t.stats.updatedAt?a("p",{staticClass:"is-capitalized"},[a("label",{attrs:{for:"#"}},[a("b-icon",{attrs:{icon:"alarm",size:"is-small"}})],1),a("span",[t._v(t._s(t.$utils.duration(t.stats.startedAt,t.stats.updatedAt)))])]):t._e()])]}}])}),a("b-table-column",{attrs:{field:"stats",label:t.$t("campaigns.stats"),width:"15%"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",{staticClass:"fields stats",attrs:{set:t.stats=t.getCampaignStats(e.row)}},[a("p",[a("label",{attrs:{for:"#"}},[t._v(t._s(t.$t("campaigns.views")))]),a("span",[t._v(t._s(t.$utils.formatNumber(e.row.views)))])]),a("p",[a("label",{attrs:{for:"#"}},[t._v(t._s(t.$t("campaigns.clicks")))]),a("span",[t._v(t._s(t.$utils.formatNumber(e.row.clicks)))])]),a("p",[a("label",{attrs:{for:"#"}},[t._v(t._s(t.$t("campaigns.sent")))]),a("span",[t._v(" "+t._s(t.$utils.formatNumber(t.stats.sent))+" / "+t._s(t.$utils.formatNumber(t.stats.toSend))+" ")])]),a("p",[a("label",{attrs:{for:"#"}},[t._v(t._s(t.$t("globals.terms.bounces")))]),a("span",[a("router-link",{attrs:{to:{name:"bounces",query:{campaign_id:e.row.id}}}},[t._v(" "+t._s(t.$utils.formatNumber(e.row.bounces))+" ")])],1)]),t.stats.rate?a("p",[a("label",{attrs:{for:"#"}},[a("b-icon",{attrs:{icon:"speedometer",size:"is-small"}})],1),a("span",{staticClass:"send-rate"},[a("b-tooltip",{attrs:{label:`${t.stats.netRate} / ${t.$t("campaigns.rateMinuteShort")} @ ${t.$utils.duration(t.stats.startedAt,t.stats.updatedAt)}`,type:"is-dark"}},[t._v(" "+t._s(t.stats.rate.toFixed(0))+" / "+t._s(t.$t("campaigns.rateMinuteShort"))+" ")])],1)]):t._e(),t.isRunning(e.row.id)?a("p",[a("label",{attrs:{for:"#"}},[t._v(" "+t._s(t.$t("campaigns.progress"))+" "),a("span",{staticClass:"spinner is-tiny"},[a("b-loading",{attrs:{"is-full-page":!1,active:""}})],1)]),a("span",[a("b-progress",{attrs:{value:t.stats.sent/t.stats.toSend*100,size:"is-small"}})],1)]):t._e()])]}}])}),a("b-table-column",{attrs:{"cell-class":"actions",width:"15%",align:"right"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",[t.$can("campaigns:manage")?[t.canStart(e.row)?a("a",{attrs:{href:"#","data-cy":"btn-start","aria-label":t.$t("campaigns.start")},on:{click:function(i){i.preventDefault(),t.$utils.confirm(null,()=>t.changeCampaignStatus(e.row,"running"))}}},[a("b-tooltip",{attrs:{label:t.$t("campaigns.start"),type:"is-dark"}},[a("b-icon",{attrs:{icon:"rocket-launch-outline",size:"is-small"}})],1)],1):t._e(),t.canPause(e.row)?a("a",{attrs:{href:"#","data-cy":"btn-pause","aria-label":t.$t("campaigns.pause")},on:{click:function(i){i.preventDefault(),t.$utils.confirm(null,()=>t.changeCampaignStatus(e.row,"paused"))}}},[a("b-tooltip",{attrs:{label:t.$t("campaigns.pause"),type:"is-dark"}},[a("b-icon",{attrs:{icon:"pause-circle-outline",size:"is-small"}})],1)],1):t._e(),t.canResume(e.row)?a("a",{attrs:{href:"#","data-cy":"btn-resume","aria-label":t.$t("campaigns.send")},on:{click:function(i){i.preventDefault(),t.$utils.confirm(null,()=>t.changeCampaignStatus(e.row,"running"))}}},[a("b-tooltip",{attrs:{label:t.$t("campaigns.send"),type:"is-dark"}},[a("b-icon",{attrs:{icon:"rocket-launch-outline",size:"is-small"}})],1)],1):t._e(),t.canSchedule(e.row)?a("a",{attrs:{href:"#","data-cy":"btn-schedule","aria-label":t.$t("campaigns.schedule")},on:{click:function(i){i.preventDefault(),t.$utils.confirm(t.$t("campaigns.confirmSchedule"),()=>t.changeCampaignStatus(e.row,"scheduled"))}}},[a("b-tooltip",{attrs:{label:t.$t("campaigns.schedule"),type:"is-dark"}},[a("b-icon",{attrs:{icon:"clock-start",size:"is-small"}})],1)],1):t._e(),!t.canCancel(e.row)&&!t.canSchedule(e.row)&&!t.canStart(e.row)?a("a",{attrs:{href:"#","data-disabled":"","aria-label":" "}},[a("b-icon",{attrs:{icon:"rocket-launch-outline",size:"is-small"}})],1):t._e(),t.canCancel(e.row)?a("a",{attrs:{href:"#","data-cy":"btn-cancel","aria-label":t.$t("globals.buttons.cancel")},on:{click:function(i){i.preventDefault(),t.$utils.confirm(null,()=>t.changeCampaignStatus(e.row,"cancelled"))}}},[a("b-tooltip",{attrs:{label:t.$t("globals.buttons.cancel"),type:"is-dark"}},[a("b-icon",{attrs:{icon:"cancel",size:"is-small"}})],1)],1):a("a",{attrs:{href:"#","data-disabled":"","aria-label":" "}},[a("b-icon",{attrs:{icon:"cancel",size:"is-small"}})],1)]:t._e(),a("a",{attrs:{href:"#","data-cy":"btn-preview","aria-label":t.$t("campaigns.preview")},on:{click:function(i){return i.preventDefault(),t.previewCampaign(e.row)}}},[a("b-tooltip",{attrs:{label:t.$t("campaigns.preview"),type:"is-dark"}},[a("b-icon",{attrs:{icon:"file-find-outline",size:"is-small"}})],1)],1),t.$can("campaigns:manage")?a("a",{attrs:{href:"#","data-cy":"btn-clone","aria-label":t.$t("globals.buttons.clone")},on:{click:function(i){i.preventDefault(),t.$utils.prompt(t.$t("globals.buttons.clone"),{placeholder:t.$t("globals.fields.name"),value:t.$t("campaigns.copyOf",{name:e.row.name})},l=>t.cloneCampaign(l,e.row))}}},[a("b-tooltip",{attrs:{label:t.$t("globals.buttons.clone"),type:"is-dark"}},[a("b-icon",{attrs:{icon:"file-multiple-outline",size:"is-small"}})],1)],1):t._e(),t.$can("campaigns:get_analytics")?a("router-link",{attrs:{to:{name:"campaignAnalytics",query:{id:e.row.id}}}},[a("b-tooltip",{attrs:{label:t.$t("globals.terms.analytics"),type:"is-dark"}},[a("b-icon",{attrs:{icon:"chart-bar",size:"is-small"}})],1)],1):t._e(),t.$can("campaigns:manage")?a("a",{attrs:{href:"#","data-cy":"btn-delete","aria-label":t.$t("globals.buttons.delete")},on:{click:function(i){i.preventDefault(),t.$utils.confirm(t.$t("campaigns.confirmDelete",{name:e.row.name}),()=>t.deleteCampaign(e.row))}}},[a("b-icon",{attrs:{icon:"trash-can-outline",size:"is-small"}})],1):t._e()],2)]}}])})],1),t.previewItem?a("campaign-preview",{attrs:{type:"campaign",id:t.previewItem.id,title:t.previewItem.name},on:{close:t.closePreview}}):t._e()],1)},_=[],y=d(h,f,_);const S=y.exports;export{S as default};
